<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<title>ê²Œì‹œê¸€ ìƒì„¸ ë³´ê¸°</title>
<link
	href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+KR:wght@400;600&display=swap"
	rel="stylesheet">

<style>
/* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
body {
	font-family: 'IBM Plex Sans KR', Arial, sans-serif;
	background-color: #f5f5f5;
	margin: 0;
	padding: 0;
	display: flex;
	justify-content: center;
	align-items: center;
	min-height: 100vh;
}

/* ë©”ì¸ ì»¨í…ì¸  */
.content {
	width: 90%;
	max-width: 800px;
	background-color: white;
	padding: 20px;
	border-radius: 10px;
	box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
	text-align: left;
}

/* ì œëª© */
h1 {
	font-size: 24px;
	color: #333;
	margin-bottom: 10px;
	text-align: center;
}

/* ì‘ì„±ì, ì¡°íšŒìˆ˜, ì‘ì„±ì¼ */
.meta-info {
	display: flex;
	justify-content: space-between;
	font-size: 14px;
	color: #555;
	margin-bottom: 20px;
	font-weight: bold;
	border-bottom: 1px solid #ddd;
	padding-bottom: 10px;
}

/* ë‚´ìš© ì„¹ì…˜ */
.content-wrapper {
	margin-bottom: 30px;
}

.content-wrapper p {
	font-size: 16px;
	color: #444;
	line-height: 1.6;
}

/* ì´ë¯¸ì§€ ì„¹ì…˜ */
.image-wrapper {
	text-align: center;
	margin-bottom: 20px;
}

.image-wrapper img {
	max-width: 100%;
	height: auto;
	border-radius: 8px;
	box-shadow: 0px 2px 6px rgba(0, 0, 0, 0.1);
}

/* ë‹µê¸€ ì„¹ì…˜ */
.reply-wrapper {
	background-color: #f9f9f9;
	padding: 20px;
	border-radius: 8px;
	box-shadow: 0px 2px 6px rgba(0, 0, 0, 0.1);
	margin-bottom: 20px;
}

.reply-wrapper h2 {
	font-size: 18px;
	margin-bottom: 15px;
	color: #333;
}

/* ë‹µê¸€ ë¦¬ìŠ¤íŠ¸ */
.reply-list {
	margin-bottom: 20px;
}

.reply-item {
	background-color: #fff;
	padding: 15px;
	margin-bottom: 10px;
	border-radius: 8px;
	border: 1px solid #ddd;
	box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.05);
}

.reply-item p {
	margin: 5px 0;
	font-size: 14px;
	color: #555;
}
/* ê¸°ë³¸ ìŠ¤íƒ€ì¼ì€ ê·¸ëŒ€ë¡œ ìœ ì§€ */
.reply-actions {
	margin-top: 10px; /* ë‹µê¸€ ë‚´ìš©ê³¼ ë²„íŠ¼ ê°„ê²© */
	display: flex;
	justify-content: flex-end; /* ë²„íŠ¼ì„ ì˜¤ë¥¸ìª½ ì •ë ¬ */
	gap: 10px; /* ë²„íŠ¼ ê°„ê²© */
}

.reply-actions a, .reply-actions form button {
	background-color: #333; /* ë²„íŠ¼ ìƒ‰ìƒ */
	color: white;
	padding: 5px 15px; /* ë²„íŠ¼ ë‚´ë¶€ ì—¬ë°± */
	border: none;
	border-radius: 5px; /* ë‘¥ê·¼ ëª¨ì„œë¦¬ */
	font-size: 12px; /* ì‘ì€ ë²„íŠ¼ ê¸€ì”¨ í¬ê¸° */
	cursor: pointer;
	text-decoration: none; /* ë§í¬ ë°‘ì¤„ ì œê±° */
	display: inline-block; /* ë²„íŠ¼ì²˜ëŸ¼ ë³´ì´ë„ë¡ */
	text-align: center;
}

.reply-actions a:hover, .reply-actions form button:hover {
	background-color: #555; /* ë²„íŠ¼ hover íš¨ê³¼ */
	color: white;
}

.reply-actions .delete-button {
	background-color: #d9534f; /* ì‚­ì œ ë²„íŠ¼ ìƒ‰ìƒ */
}

.reply-actions .delete-button:hover {
	background-color: #c9302c; /* ì‚­ì œ ë²„íŠ¼ hover */
}

.reply-item strong {
	color: #333;
}

/* ë‹µê¸€ ì‘ì„± í¼ */
.reply-form {
	display: flex;
	flex-direction: column;
	gap: 10px;
}

.reply-form textarea {
	width: 100%;
	padding: 10px;
	font-size: 14px;
	border: 1px solid #ddd;
	border-radius: 5px;
	resize: none;
}

.reply-form button {
	align-self: flex-end;
	background-color: #333;
	color: white;
	padding: 10px 20px;
	font-weight: bold;
	border: none;
	border-radius: 5px;
	cursor: pointer;
	font-size: 14px;
}

.reply-form button:hover {
	background-color: #555;
}

/* ë²„íŠ¼ ì„¹ì…˜ */
.button-container {
	display: flex;
	font-weight: bold;
	justify-content: space-between;
	align-items: center;
	margin-top: 20px;
}

.button-container button, .button-container a {
	background-color: #333;
	color: white;
	padding: 10px 20px;
	border: none;
	border-radius: 5px;
	font-weight: bold;
	font-size: 14px;
	text-decoration: none;
	text-align: center;
	cursor: pointer;
}

.button-container button:hover, .button-container a:hover {
	background-color: #555;
}

.delete-button {
	background-color: #d9534f;
}

.delete-button:hover {
	background-color: #c9302c;
}
</style>
<script>
	// ì¢‹ì•„ìš” ìš”ì²­ (JSON ì‘ë‹µ ê°€ì •)
	async function handleLikePost(postId) {
		try {
			const response = await
			fetch(`/community/${postId}/like`, {
				method : 'POST'
			});

			if (response.ok) {
				// ì„œë²„ì—ì„œ JSONì„ ë°›ëŠ”ë‹¤. ì˜ˆ: { message: "ì¢‹ì•„ìš”ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.", likes: 10 }
				const data = await
				response.json();

				// ì¢‹ì•„ìš” ìˆ«ìë¥¼ í‘œì‹œí•˜ëŠ” ìš”ì†Œ
				const likesElement = document.getElementById("likes-count");

				// ì¢‹ì•„ìš” ìˆ«ì ì—…ë°ì´íŠ¸
				if (likesElement) {
					likesElement.textContent = data.likes;
				}

				// ë©”ì‹œì§€ í‘œì‹œ
				alert(data.message);

			} else {
				// ì‘ë‹µì´ 2xxê°€ ì•„ë‹ ë•Œ
				const errorText = await
				response.text();
				alert(`ì¢‹ì•„ìš” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${errorText}`);
			}
		} catch (error) {
			console.error("Fetch Exception:", error);
			alert("ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
		}
	}

	// ì‹«ì–´ìš” ìš”ì²­
	async function handleDislikePost(postId) {
    try {
        const response = await fetch(`/community/${postId}/dislike`, {
            method: 'POST'
        });

        if (response.ok) {
            const data = await response.json();

            // ì‹«ì–´ìš” ìˆ«ì ì—…ë°ì´íŠ¸
            const dislikesElement = document.getElementById("dislikes-count");
            if (dislikesElement) {
                dislikesElement.textContent = data.dislikes;
            }

            alert(data.message);
        } else {
            const errorText = await response.text();
            alert(`ì‹«ì–´ìš” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${errorText}`);
        }
    } catch (error) {
        console.error("Fetch Exception:", error);
        alert("ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
}

	async function handleLikeReply(replyId, userId) {
		if (!userId) {
			alert("ë¡œê·¸ì¸ í›„ ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤."); // ë¡œê·¸ì¸ë˜ì§€ ì•Šì€ ê²½ìš° ì²˜ë¦¬
			return;
		}

		try {
			const response = await
			fetch(`/community/reply/${replyId}/like?userId=${userId}`, {
				method : 'POST',
			});
			const result = await
			response.text();
			const likeCountSpan = document
					.getElementById(`reply-likes-count-${replyId}`);
			let currentLikes = parseInt(likeCountSpan.textContent);

			if (response.ok) {
				if (result === "ë‹µê¸€ ì¢‹ì•„ìš”ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.") {
					likeCountSpan.textContent = currentLikes + 1;
				} else if (result === "ë‹µê¸€ ì¢‹ì•„ìš”ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.") {
					likeCountSpan.textContent = currentLikes - 1;
				}
			} else {
				alert("ì¢‹ì•„ìš” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
			}
		} catch (error) {
			console.error(error);
			alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
		}
	}

	// ë“œë¡­ë‹¤ìš´ ë©”ë‰´ í† ê¸€
	document.addEventListener('DOMContentLoaded', function() {
		const dropdownButton = document.getElementById('dropdownButton');
		const dropdownMenu = document.getElementById('dropdownMenu');

		// ë²„íŠ¼ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ë©”ë‰´ í‘œì‹œ/ìˆ¨ê¹€
		dropdownButton.addEventListener('click', function(event) {
			event.stopPropagation(); // í´ë¦­ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
			const isDisplayed = dropdownMenu.style.display === 'block';
			dropdownMenu.style.display = isDisplayed ? 'none' : 'block';
		});

		// ë©”ë‰´ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
		document.addEventListener('click', function() {
			dropdownMenu.style.display = 'none';
		});
	});
	
	document.addEventListener("DOMContentLoaded", function () {
	    const chatbotToggle = document.getElementById("chatbot-toggle");
	    const chatbotWindow = document.getElementById("chatbot-window");
	    const chatbotClose = document.getElementById("chatbot-close");
	    const chatbotSend = document.getElementById("chatbot-send");
	    const chatbotInput = document.getElementById("chatbot-input");
	    const chatbotMessages = document.getElementById("chatbot-messages");

	    // ì±—ë´‡ ì—´ê¸°/ë‹«ê¸°
	    chatbotToggle.addEventListener("click", () => {
	        chatbotWindow.style.display = chatbotWindow.style.display === "none" ? "block" : "none";
	    });

	    chatbotClose.addEventListener("click", () => {
	        chatbotWindow.style.display = "none";
	    });

	    // ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
	    async function sendMessage() {
	        const userInput = chatbotInput.value.trim();
	        if (!userInput) return;

	        // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
	        chatbotMessages.innerHTML += `<div style="text-align: right; margin: 10px 0;">
	            <span style="display: inline-block; background: #f1f1f1; color: #333; padding: 8px 12px; border-radius: 12px; max-width: 80%; font-size: 14px;">
	                ${userInput}
	            </span>
	        </div>`;
	        chatbotInput.value = "";

	        // ì„œë²„ì— ë©”ì‹œì§€ ì „ì†¡
	        try {
	            const response = await fetch("/api/chatbot", {
	                method: "POST",
	                headers: { "Content-Type": "application/json" },
	                body: JSON.stringify({ question: userInput }),
	            });

	            const data = await response.text();

	            // ì±—ë´‡ ì‘ë‹µ ì¶”ê°€
	            chatbotMessages.innerHTML += `<div style="text-align: left; margin: 10px 0;">
	                <span style="display: inline-block; background: #f1f1f1; color: #333; padding: 8px 12px; border-radius: 12px; max-width: 80%; font-size: 14px;">
	                    ì±—ë´‡: ${data}
	                </span>
	            </div>`;
	            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
	        } catch (error) {
	            chatbotMessages.innerHTML += `<div style="text-align: left; margin: 10px 0;">
	                <span style="display: inline-block; background: #ffe6e6; color: #d32f2f; padding: 8px 12px; border-radius: 12px; max-width: 80%; font-size: 14px;">
	                    ì±—ë´‡: ì„œë²„ì™€ ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
	                </span>
	            </div>`;
	        }
	    }

	    // ì „ì†¡ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
	    chatbotSend.addEventListener("click", sendMessage);

	    // ì—”í„° í‚¤ ì´ë²¤íŠ¸
	    chatbotInput.addEventListener("keydown", (event) => {
	        if (event.key === "Enter" && !event.isComposing) {
	            event.preventDefault();
	            sendMessage();
	        }
	    });
	});
</script>
</head>

<body>
	<div class="content">
		<h1 th:text="${post.title}">ì œëª©</h1>

		<div class="meta-info">
			<span><strong>ì‘ì„±ì:</strong> <span th:text="${post.author}">ì‘ì„±ì</span></span>
			<span><strong>ì¡°íšŒìˆ˜:</strong> <span th:text="${post.views}">ì¡°íšŒìˆ˜</span></span>
			<span><strong>ì‘ì„±ì¼:</strong> <span
				th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}">ì‘ì„±ì¼</span>
			</span> <span th:if="${post.attachmentPath != null}"> <strong>ì²¨ë¶€íŒŒì¼:</strong>
				<a th:href="@{${post.attachmentPath}}" download>ë‹¤ìš´ë¡œë“œ</a>
			</span> <span><strong>ì¢‹ì•„ìš”:</strong> <span id="likes-count"
				th:text="${post.likes}">0</span></span> 
				 <span><strong>ì‹«ì–´ìš”:</strong> 
        <span id="dislikes-count" th:text="${post.dislikes}">0</span>
    </span>
		</div>

		<div class="image-wrapper" th:if="${post.imagePath != null}">
			<img
				th:src="@{/uploads/images/} + ${post.imagePath.split('/images/')[1]}"
				alt="ì²¨ë¶€ ì´ë¯¸ì§€">
		</div>

		<div class="content-wrapper">
			<p th:text="${post.content}">ë‚´ìš©</p>
		</div>

		<div style="margin-top: 20px; text-align: center;">
			<span id="likes-count-${post.id}"> <!-- ì¢‹ì•„ìš” ë²„íŠ¼ -->
				<button th:onclick="'handleLikePost(' + ${post.id} + ')'"
					style="background: none; border: none; cursor: pointer;">
					<img src="/like.png" alt="ì¢‹ì•„ìš”" style="width: 30px; height: 30px;">ì¢‹ì•„ìš”
				</button> 				
				 <!-- ì‹«ì–´ìš” ë²„íŠ¼ -->
    <button th:onclick="'handleDislikePost(' + ${post.id} + ')'" 
            style="background: none; border: none; cursor: pointer;">
        <img src="/dislike.png" alt="ì‹«ì–´ìš”" style="width: 30px; height: 30px;">ì‹«ì–´ìš”
    </button>
		</div>



		<!-- ë‹µê¸€ ì„¹ì…˜ -->
		<div class="reply-wrapper">
			<div
				style="margin-bottom: 20px; position: relative; display: inline-block;">
				<!-- ë“œë¡­ë‹¤ìš´ ë²„íŠ¼ -->
				<button id="dropdownButton"
					style="padding: 0; background: none; border: none; cursor: pointer;">
					<img src="/sort.png" alt="ì •ë ¬" style="width: 30px; height: 30px;">
				</button>

				<!-- ë“œë¡­ë‹¤ìš´ ë©”ë‰´ -->
				<div id="dropdownMenu"
					style="display: none; position: absolute; background-color: white; border: 1px solid #ddd; border-radius: 5px; box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1); min-width: 150px; z-index: 100;">
					<a th:href="@{/community/{id}(id=${post.id}, sort='latest')}"
						style="display: block; padding: 10px; text-decoration: none; font-weight: bold; color: #333;">
						ìµœì‹ ìˆœ </a> <a th:href="@{/community/{id}(id=${post.id}, sort='likes')}"
						style="display: block; padding: 10px; text-decoration: none; font-weight: bold; color: #333;">
						ì¢‹ì•„ìš”ìˆœ </a> <a
						th:href="@{/community/{id}(id=${post.id}, sort='oldest')}"
						style="display: block; padding: 10px; text-decoration: none; font-weight: bold; color: #333;">
						ì˜¤ë˜ëœìˆœ </a>
				</div>
			</div>


			<!-- ë‹µê¸€ ëª©ë¡ -->
			<div class="reply-list">
				<div th:each="reply : ${replies}" class="reply-item">
					<p>
						<strong th:text="${reply.author}">ì‘ì„±ì</strong> <span
							th:text="${#temporals.format(reply.createdAt, 'yyyy-MM-dd HH:mm')}">ì‘ì„±ì¼</span>
					</p>
					<p th:text="${reply.content}">ë‹µê¸€ ë‚´ìš©</p>

					<!-- ====== ì—¬ê¸°ì„œë¶€í„° ë‹µê¸€ ì¢‹ì•„ìš” ì˜ì—­ ====== -->
					<div style="margin-top: 15px; display: flex; align-items: center;">
						<button type="button"
							th:onclick="'handleLikeReply(' + ${reply.id} + ', ' + (${userId} != null ? ${userId} : 0) + ')'"
							style="background: none; border: none; cursor: pointer;">
							<img src="/like.png" alt="ì¢‹ì•„ìš”" style="width: 20px; height: 20px;">
						</button>
						<span style="margin-left: 10px;"
							th:id="'reply-likes-count-' + ${reply.id}"
							th:text="${reply.likes != null ? reply.likes : 0}">0</span>
					</div>



					<!-- ===================================== -->

					<!-- ìˆ˜ì • ë° ì‚­ì œ ë²„íŠ¼ -->
					<div th:if="${session.loggedInUsername == reply.author}"
						class="reply-actions">
						<a
							th:href="@{/community/{postId}/reply/{replyId}/edit(postId=${post.id}, replyId=${reply.id})}">ìˆ˜ì •</a>
						<form
							th:action="@{/community/{postId}/reply/{replyId}/delete(postId=${post.id}, replyId=${reply.id})}"
							method="post" style="display: inline;">
							<button type="submit" class="delete-button"
								onclick="return confirm('ì´ ë‹µê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</button>
						</form>
					</div>
				</div>
			</div>

			<!-- ë‹µê¸€ ì‘ì„± í¼ -->
			<form th:action="@{/community/{id}/reply(id=${post.id})}"
				method="post" class="reply-form">
				<textarea name="content" rows="3" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."
					required></textarea>
				<button type="submit">ë‹µê¸€ ì‘ì„±</button>
			</form>
		</div>

		<!-- ë²„íŠ¼ë“¤ -->
		<div class="button-container">
			<button onclick="location.href='/community'">ëª©ë¡ìœ¼ë¡œ</button>
			<div>
				<a th:if="${session.loggedInUsername == post.author}"
					th:href="@{/community/{id}/edit(id=${post.id})}"> ìˆ˜ì • </a>
				<form th:if="${session.loggedInUsername == post.author}"
					th:action="@{/community/{id}/delete(id=${post.id})}" method="post"
					style="display: inline;">
					<button type="submit" class="delete-button"
						onclick="return confirm('ì´ ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</button>
				</form>
			</div>
		</div>
	</div>
	<!-- Chatbot UI -->
<div id="chatbot-container" style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
    <div id="chatbot-window" style="display: none; width: 500px; height: 570px; background: white; border: 1px solid #ccc; box-shadow: 0px 4px 8px rgba(0,0,0,0.2); border-radius: 8px;">
        <!-- ì±—ë´‡ í—¤ë” -->
        <div style="background: #333; color: white; padding: 10px; border-top-left-radius: 8px; border-top-right-radius: 8px; font-weight: bold;">
            ì±—ë´‡
            <button id="chatbot-close" style="float: right; background: none; border: none; color: white; font-size: 16px; cursor: pointer;">Ã—</button>
        </div>
        <!-- ë©”ì‹œì§€ ì˜ì—­ -->
        <div id="chatbot-messages" style="padding: 10px; height: 450px; overflow-y: auto; font-size: 14px; border-bottom: 1px solid #ccc;">
            <!-- ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>
        <!-- ì…ë ¥ì°½ -->
        <div style="padding: 5px; border-top: 1px solid #ccc; display: flex; gap: 5px; align-items: center;">
            <input id="chatbot-input" type="text" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”" style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
            <button id="chatbot-send" style="padding: 8px 12px; background: #333; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold;">ì „ì†¡</button>
        </div>
    </div>
    <button id="chatbot-toggle" style="width: 70px; height: 70px; background: #333; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 22px;">ğŸ’¬</button>
</div>
</body>
</html>
